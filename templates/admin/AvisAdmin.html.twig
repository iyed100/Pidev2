{% extends 'admin/base_admin.html.twig' %}

{% block body %}
<!-- Avis Section -->
<div class="card-elegent card mb-4">
    <div class="card-header py-3 bg-primary text-white">
        <h6 class="m-0 font-weight-bold">
            <i class="fas fa-star me-2"></i> Reviews ({{ avis|length }})
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Comment</th>
                        <th>Rating</th>
                        <th>User</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for avi in avis %}
                        <tr>
                            <td>{{ avi.id }}</td>
                            <td>{{ avi.comment|u.truncate(50, '...') }}</td>
                            <td>
                                <span class="badge bg-{{ avi.note >= 4 ? 'success' : (avi.note >= 2 ? 'warning' : 'danger') }}">
                                    {{ avi.note }}/5
                                </span>
                            </td>
                            <td>User #{{ avi.userId }}</td>
                            <td>
                                <form method="post" action="{{ path('avis_delete', {'id': avi.id}) }}" 
                                      onsubmit="return confirm('Delete this review?')">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ avi.id) }}">
                                    <button class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% else %}
                        <tr><td colspan="5">No reviews found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Claims Section -->
<div class="card-elegent card">
    <div class="card-header py-3 bg-warning text-dark">
        <h6 class="m-0 font-weight-bold">
            <i class="fas fa-exclamation-triangle me-2"></i> Claims ({{ claims|length }})
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>User</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for claim in claims %}
                        <tr>
                            <td>{{ claim.id }}</td>
                            <td>{{ claim.description|u.truncate(30, '...') }}</td>
                            <td>
                                <form method="post" action="{{ path('admin_claim_status', {'id': claim.id}) }}">
                                    <input type="hidden" name="_token" value="{{ csrf_token('status' ~ claim.id) }}">
                                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                                        <option value="pending" {{ claim.status == 'pending' ? 'selected' : '' }}>Pending</option>
                                        <option value="in_progress" {{ claim.status == 'in_progress' ? 'selected' : '' }}>In Progress</option>
                                        <option value="resolved" {{ claim.status == 'resolved' ? 'selected' : '' }}>Resolved</option>
                                    </select>
                                </form>
                            </td>
                            <td>{{ claim.cdate|date('Y-m-d') }}</td>
                            <td>User #{{ claim.userId }}</td>
                            <td class="d-flex gap-2">
                                <!-- Delete Button -->
                                <form method="post" action="{{ path('claim_delete', {'id': claim.id}) }}"
                                      onsubmit="return confirm('Delete this claim?')">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ claim.id) }}">
                                    <button class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                
                                <!-- Response Form Toggle Button -->
                                <button class="btn btn-sm btn-info" 
                                        onclick="document.getElementById('response-form-{{ claim.id }}').style.display='block'">
                                    <i class="fas fa-reply"></i>
                                </button>
                            </td>
                        </tr>
                        <!-- Display Existing Responses -->
    {% for response in claim.responses %}
        <tr>
            <td colspan="6" class="bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Response ({{ response.createdAt|date('Y-m-d H:i') }}):</strong>
                        {{ response.content }}
                    </div>
                    <form method="post" action="{{ path('admin_response_delete', {'id': response.id}) }}"
                          onsubmit="return confirm('Delete this response?')">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ response.id) }}">
                        <button class="btn btn-sm btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </td>
        </tr>
    {% endfor %}
                        <!-- Response Form (Hidden by Default) -->
                        <tr id="response-form-{{ claim.id }}" style="display:none">
                            <td colspan="6">
                                {{ form_start(responseForms[claim.id], {
                                    'action': path('admin_claim_response', {'id': claim.id}),
                                    'attr': {'class': 'response-form'}
                                }) }}
                                    <div class="input-group mb-3">
                                        {{ form_widget(responseForms[claim.id].content, {
                'attr': {
                    'class': 'form-control',
                    'placeholder': 'Type your response here...'
                }
            }) }}
                                        <button class="btn btn-primary" type="submit" name="submit">
                <i class="fas fa-paper-plane"></i> Send
            </button>
                                    </div>
                                    {{ form_rest(responseForms[claim.id]) }}
                                {{ form_end(responseForms[claim.id]) }}
                            </td>
                        </tr>
                        
                        <!-- Display Existing Responses -->
                        {% for response in claim.responses %}
                            <tr>
                                <td colspan="6" class="bg-light">
                                    <small>
                                        <strong>Response ({{ response.createdAt|date('Y-m-d H:i') }}):</strong>
                                        {{ response.content }}
                                    </small>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="6">No claims found</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}